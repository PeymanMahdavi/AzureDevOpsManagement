parameters:
  - name: repository
    type: string

jobs:
- job: CheckDefaultBranch
  displayName: 'Check Default Branch'
  condition: and(succeeded(), eq(variables['Build.Reason'], 'Manual'))
  steps:
  - checkout: none
  - template: get-default-branch.yml
    parameters:
      repository: ${{ parameters.repository }}
      organizationUrl: $(System.CollectionUri)
      projectName: $(System.TeamProject)
  - bash: |
        echo "Default branch for repository '${{ parameters.repository }}' is: $(defaultBranch)"
        echo "##vso[task.setvariable variable=theBranch;isOutput=true]$(defaultBranch)"
    name: setDefaultBranch

- job: CheckPermissions
  displayName: 'Check Permissions'
  dependsOn: CheckDefaultBranch
  condition: and(succeeded(), eq(variables['Build.Reason'], 'Manual'))
  variables:
    targetBranch: $[ dependencies.CheckDefaultBranch.outputs['setDefaultBranch.theBranch'] ]
  steps:
  - checkout: none
  - template: get-branch-permissions.yml
    parameters:
      repository: ${{ parameters.repository }}
      projectName: $(System.TeamProject)
  - bash: |
        echo "##vso[task.setvariable variable=denyForcePush;isOutput=true]$denyForcePush"
        echo "##vso[task.setvariable variable=denyEditPolicies;isOutput=true]$denyEditPolicies"
        echo "##vso[task.setvariable variable=denyBypassPR;isOutput=true]$denyBypassPR"
        echo "##vso[task.setvariable variable=denyBypassPush;isOutput=true]$denyBypassPush"
    name: setBranchPermissionsStatus
